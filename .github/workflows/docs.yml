name: Documentation

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  update-docs:
    name: Generate Docs
    runs-on: ubuntu-latest
    environment: docs
    steps:
      - name: Checkout fish-audio-go
        uses: actions/checkout@v6
        with:
          path: sdk
          persist-credentials: false

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: stable
          cache-dependency-path: sdk/go.sum

      - name: Install gomarkdoc
        run: go install github.com/princjef/gomarkdoc/cmd/gomarkdoc@latest

      - name: Generate API documentation
        working-directory: sdk
        run: gomarkdoc -o build/docs/fishaudio.md .

      - name: Checkout docs
        uses: actions/checkout@v6
        with:
          repository: ${{ vars.DOCS_REPO }}
          path: docs
          persist-credentials: false

      - name: Copy generated documentation
        run: python sdk/scripts/copy_docs.py sdk docs

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.DOCS_TOKEN }}
          path: docs
          commit-message: |
            chore: update Go SDK API reference

            Auto-generated from fishaudio/fish-audio-go@${{ github.sha }}
          author: ${{ vars.BOT_NAME }} <${{ vars.BOT_EMAIL }}>
          committer: ${{ vars.BOT_NAME }} <${{ vars.BOT_EMAIL }}>
          branch: auto/go-api-docs
          delete-branch: true
          title: "Update Go SDK API Reference"
          body: |
            Auto-generated API documentation update from [fish-audio-go@${{ github.sha }}](https://github.com/fishaudio/fish-audio-go/commit/${{ github.sha }})

            ## Changes
            - Updated API reference documentation for Go SDK
            - Generated from latest doc comments in the codebase

          labels: |
            go